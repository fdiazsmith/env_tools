#!/usr/bin/env python3

"""
imgcli - Image CLI tool for image processing
"""

import argparse
import os
import subprocess
import sys
from pathlib import Path


# Color codes for terminal output
class Colors:
    RED = '\033[0;31m'
    GREEN = '\033[0;32m'
    YELLOW = '\033[1;33m'
    BLUE = '\033[0;34m'
    NC = '\033[0m'  # No Color


def print_error(message):
    """Print error message in red"""
    print(f"{Colors.RED}Error: {message}{Colors.NC}", file=sys.stderr)


def print_success(message):
    """Print success message in green"""
    print(f"{Colors.GREEN}✓ {message}{Colors.NC}")


def print_info(message):
    """Print info message in blue"""
    print(f"{Colors.BLUE}{message}{Colors.NC}")


def print_warning(message):
    """Print warning message in yellow"""
    print(f"{Colors.YELLOW}⚠ {message}{Colors.NC}")


def check_imagemagick():
    """Check if ImageMagick (convert) is installed"""
    try:
        subprocess.run(['convert', '-version'],
                      stdout=subprocess.DEVNULL,
                      stderr=subprocess.DEVNULL,
                      check=True)
        return True
    except (subprocess.CalledProcessError, FileNotFoundError):
        return False


def convert_to_webp(input_file, output_file=None, scale=None):
    """
    Convert image to WebP format with optional scaling

    Args:
        input_file: Path to input image file
        output_file: Path to output WebP file (optional)
        scale: Scale multiplier (e.g., 0.5 for half size, 2.0 for double size)
    """
    # Validate input file
    if not os.path.isfile(input_file):
        print_error(f"Input file not found: {input_file}")
        return False

    # Generate output filename if not provided
    if output_file is None:
        input_path = Path(input_file)
        output_file = str(input_path.parent / f"{input_path.stem}.webp")

    # Ensure output has .webp extension
    if not output_file.lower().endswith('.webp'):
        output_file += '.webp'

    # Check if output file already exists
    if os.path.exists(output_file):
        response = input(f"{Colors.YELLOW}Output file '{output_file}' already exists. Overwrite? (y/n): {Colors.NC}")
        if response.lower() not in ['y', 'yes']:
            print("Operation cancelled.")
            return False

    # Build ImageMagick command
    cmd = ['convert', input_file]

    # Add scaling if specified
    if scale is not None:
        scale_percent = int(scale * 100)
        cmd.extend(['-resize', f'{scale_percent}%'])

    # Add WebP compression (quality 90 for good balance)
    cmd.extend(['-quality', '90', output_file])

    # Show the command being executed
    print_info(f"Converting: {os.path.basename(input_file)} to WebP")
    if scale is not None:
        print_info(f"Scale: {scale}x ({scale * 100:.0f}%)")
    print_info(f"Output: {output_file}")
    print()

    try:
        # Run ImageMagick convert
        subprocess.run(cmd, check=True)
        print()
        print_success(f"Successfully created: {output_file}")

        # Show file sizes
        input_size = os.path.getsize(input_file) / 1024
        output_size = os.path.getsize(output_file) / 1024
        print_info(f"Input size:  {input_size:.2f} KB")
        print_info(f"Output size: {output_size:.2f} KB")
        compression_ratio = ((input_size - output_size) / input_size * 100) if input_size > 0 else 0
        print_info(f"Compression: {compression_ratio:.1f}%")

        return True

    except subprocess.CalledProcessError as e:
        print_error(f"ImageMagick conversion failed: {e}")
        return False
    except KeyboardInterrupt:
        print()
        print_warning("Operation cancelled by user")
        # Clean up partial output file
        if os.path.exists(output_file):
            os.remove(output_file)
            print_info("Cleaned up partial output file")
        return False


def create_ico(input_file, output_file=None, sizes=None):
    """
    Convert image to ICO format with multiple resolutions

    Args:
        input_file: Path to input image file
        output_file: Path to output ICO file (optional)
        sizes: List of sizes to include (default: [16, 32, 48, 64, 128, 256])
    """
    # Validate input file
    if not os.path.isfile(input_file):
        print_error(f"Input file not found: {input_file}")
        return False

    # Default ICO sizes
    if sizes is None:
        sizes = [16, 32, 48, 64, 128, 256]

    # Generate output filename if not provided
    if output_file is None:
        input_path = Path(input_file)
        output_file = str(input_path.parent / f"{input_path.stem}.ico")

    # Ensure output has .ico extension
    if not output_file.lower().endswith('.ico'):
        output_file += '.ico'

    # Check if output file already exists
    if os.path.exists(output_file):
        response = input(f"{Colors.YELLOW}Output file '{output_file}' already exists. Overwrite? (y/n): {Colors.NC}")
        if response.lower() not in ['y', 'yes']:
            print("Operation cancelled.")
            return False

    # Build ImageMagick command
    # Create multiple sizes and combine into ICO
    size_args = []
    for size in sizes:
        size_args.extend([
            '(', input_file,
            '-resize', f'{size}x{size}',
            '-background', 'none',
            '-flatten',
            ')'
        ])

    cmd = ['convert'] + size_args + [output_file]

    # Show the command being executed
    print_info(f"Converting: {os.path.basename(input_file)} to ICO")
    print_info(f"Sizes: {', '.join(f'{s}x{s}' for s in sizes)}")
    print_info(f"Output: {output_file}")
    print()

    try:
        # Run ImageMagick convert
        subprocess.run(cmd, check=True)
        print()
        print_success(f"Successfully created: {output_file}")

        # Show file sizes
        input_size = os.path.getsize(input_file) / 1024
        output_size = os.path.getsize(output_file) / 1024
        print_info(f"Input size:  {input_size:.2f} KB")
        print_info(f"Output size: {output_size:.2f} KB")

        return True

    except subprocess.CalledProcessError as e:
        print_error(f"ImageMagick conversion failed: {e}")
        return False
    except KeyboardInterrupt:
        print()
        print_warning("Operation cancelled by user")
        # Clean up partial output file
        if os.path.exists(output_file):
            os.remove(output_file)
            print_info("Cleaned up partial output file")
        return False


def show_interactive_menu():
    """Display interactive menu for image operations"""
    while True:
        print()
        print(f"{Colors.GREEN}{'=' * 50}{Colors.NC}")
        print(f"{Colors.GREEN}         imgcli - Image Processing Tool{Colors.NC}")
        print(f"{Colors.GREEN}{'=' * 50}{Colors.NC}")
        print()
        print("Available operations:")
        print()
        print(f"  {Colors.BLUE}1.{Colors.NC} Convert to ICO format")
        print(f"  {Colors.BLUE}2.{Colors.NC} Convert to WebP format")
        print(f"  {Colors.BLUE}3.{Colors.NC} Exit")
        print()

        try:
            choice = input(f"Select an option (1-3): ").strip()

            if choice == '1':
                print()
                input_file = input("Enter path to image file: ").strip()

                if not input_file:
                    print_error("No input file provided")
                    continue

                # Ask about custom sizes
                use_custom = input("Use custom sizes? (y/n, default: n): ").strip().lower()
                sizes = None

                if use_custom in ['y', 'yes']:
                    sizes_input = input("Enter sizes comma-separated (e.g., 16,32,48,128): ").strip()
                    try:
                        sizes = [int(s.strip()) for s in sizes_input.split(',')]
                        if not sizes or any(s <= 0 for s in sizes):
                            print_error("Invalid sizes")
                            continue
                    except ValueError:
                        print_error("Invalid sizes format")
                        continue

                # Ask about output file
                output_file = input("Output file (press Enter for auto-naming): ").strip()
                if not output_file:
                    output_file = None

                print()
                create_ico(input_file, output_file, sizes)

            elif choice == '2':
                print()
                input_file = input("Enter path to image file: ").strip()

                if not input_file:
                    print_error("No input file provided")
                    continue

                # Ask about scaling
                scale_input = input("Scale multiplier (press Enter for no scaling): ").strip()
                scale = None
                if scale_input:
                    try:
                        scale = float(scale_input)
                        if scale <= 0:
                            print_error("Scale must be positive")
                            continue
                    except ValueError:
                        print_error("Invalid scale value")
                        continue

                # Ask about output file
                output_file = input("Output file (press Enter for auto-naming): ").strip()
                if not output_file:
                    output_file = None

                print()
                convert_to_webp(input_file, output_file, scale)

            elif choice == '3':
                print("Goodbye!")
                sys.exit(0)
            else:
                print_error("Invalid option")

        except KeyboardInterrupt:
            print()
            print("Goodbye!")
            sys.exit(0)


def main():
    """Main entry point"""
    parser = argparse.ArgumentParser(
        description='Image processing CLI tool using ImageMagick',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Interactive mode
  imgcli

  # Convert to ICO with default sizes
  imgcli --ico image.png

  # Convert to ICO with custom sizes
  imgcli --ico image.png --sizes 16,32,48,256

  # Convert with custom output filename
  imgcli --ico image.png --output favicon.ico

  # Convert with custom sizes and output
  imgcli --ico image.png --sizes 16,32,64 --output custom.ico

  # Convert to WebP
  imgcli --web image.png

  # Convert to WebP with scaling (0.5 = half size, 2.0 = double size)
  imgcli --web image.png --scale 0.5

  # Convert to WebP with custom output
  imgcli --web image.png --output compressed.webp --scale 0.75

Output:
  By default, output files are named '{input}.ico' or '{input}.webp'
  in the same directory. Use --output to specify a custom output path.

ICO format:
  - Default sizes: 16x16, 32x32, 48x48, 64x64, 128x128, 256x256
  - Maintains transparency for PNG inputs
  - Optimized for Windows icons and favicons

WebP format:
  - High quality compression (quality 90)
  - Supports transparency
  - Ideal for web usage
        """
    )

    parser.add_argument('--ico', metavar='INPUT',
                       help='Convert image to ICO format')

    parser.add_argument('--web', metavar='INPUT',
                       help='Convert image to WebP format')

    parser.add_argument('--sizes', metavar='SIZE,SIZE,...',
                       help='Comma-separated list of sizes to include in ICO (e.g., 16,32,48,256)')

    parser.add_argument('--scale', type=float, metavar='MULTIPLIER',
                       help='Scale multiplier for WebP conversion (e.g., 0.5 for half size, 2.0 for double size)')

    parser.add_argument('--output', '-o', metavar='FILE',
                       help='Output file path')

    # Parse arguments
    args = parser.parse_args()

    # Check if ImageMagick is installed
    if not check_imagemagick():
        print_error("ImageMagick is not installed or not in PATH")
        print_info("Install ImageMagick:")
        print_info("  macOS:  brew install imagemagick")
        print_info("  Ubuntu: sudo apt install imagemagick")
        sys.exit(1)

    # If no arguments provided, show interactive menu
    if len(sys.argv) == 1:
        show_interactive_menu()
        return

    # Ensure --ico and --web are not used together
    if args.ico and args.web:
        print_error("Cannot use --ico and --web together")
        sys.exit(1)

    # Handle --ico command
    if args.ico:
        # Validate --scale not used with --ico
        if args.scale:
            print_error("--scale can only be used with --web")
            sys.exit(1)

        sizes = None

        # Parse sizes if provided
        if args.sizes:
            try:
                sizes = [int(s.strip()) for s in args.sizes.split(',')]
                if not sizes or any(s <= 0 for s in sizes):
                    print_error("Invalid sizes: all sizes must be positive integers")
                    sys.exit(1)
            except ValueError:
                print_error("Invalid sizes format. Use comma-separated integers (e.g., 16,32,48)")
                sys.exit(1)

        # Run ICO conversion
        success = create_ico(args.ico, args.output, sizes)
        sys.exit(0 if success else 1)

    # Handle --web command
    if args.web:
        # Validate --sizes not used with --web
        if args.sizes:
            print_error("--sizes can only be used with --ico")
            sys.exit(1)

        # Validate scale if provided
        if args.scale is not None and args.scale <= 0:
            print_error("Scale must be a positive number")
            sys.exit(1)

        # Run WebP conversion
        success = convert_to_webp(args.web, args.output, args.scale)
        sys.exit(0 if success else 1)

    # If --sizes, --scale, or --output provided without --ico or --web, show error
    if args.sizes or args.scale or args.output:
        print_error("--sizes, --scale, and --output must be used with --ico or --web")
        print_info("Usage: imgcli --ico INPUT [--sizes SIZE,SIZE,...] [--output FILE]")
        print_info("       imgcli --web INPUT [--scale MULTIPLIER] [--output FILE]")
        sys.exit(1)

    # Should not reach here, but just in case
    parser.print_help()


if __name__ == '__main__':
    main()
